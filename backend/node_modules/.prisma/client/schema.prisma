generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(cuid())
  login           String           @unique
  email           String           @unique
  name            String
  passwordHash    String
  role            String           @default("USER")
  twoFASecret     String?
  dailyQuota      Int              @default(5)
  messagesSent    Message[]        @relation("messagesSent")
  messagesRecv    Message[]        @relation("messagesRecv")
  sandboxSessions SandboxSession[]
}

model Message {
  id          String       @id @default(cuid())
  subject     String
  body        String
  createdAt   DateTime     @default(now())
  readAt      DateTime?
  senderId    String
  recipientId String
  sender      User         @relation("messagesSent", fields: [senderId], references: [id])
  recipient   User         @relation("messagesRecv", fields: [recipientId], references: [id])
  attachments Attachment[]
}

model Attachment {
  id              String           @id @default(cuid())
  filename        String
  storageName     String
  mime            String
  size            Int
  messageId       String
  message         Message          @relation(fields: [messageId], references: [id])
  sandboxSessions SandboxSession[]
}

model SandboxSession {
  id           String     @id @default(cuid())
  userId       String
  attachmentId String
  status       String
  resultType   String
  previewPath  String?
  reportPath   String?
  createdAt    DateTime   @default(now())
  durationMs   Int
  user         User       @relation(fields: [userId], references: [id])
  attachment   Attachment @relation(fields: [attachmentId], references: [id])
}
